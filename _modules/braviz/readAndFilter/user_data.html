<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>braviz.readAndFilter.user_data &mdash; Braviz Documentation</title>
    
    <link rel="stylesheet" href="../../../_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.3b',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/fold_classes.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
    <link rel="top" title="Braviz Documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    
    <div class="header-wrapper">
      <div class="header">
          <p class="logo"><a href="../../../index.html">
            <img class="logo" src="../../../_static/Logo_Bravis_h.png" alt="Logo"/>
          </a></p>
          <!--
        <div class="headertitle"><a
          href="../../../index.html"> Documentation </a></div>
          -->
          <nav class="parents">
              <ol>
        <li><a href="../../../index.html"> Home </a> &raquo;</li>
          <li><a href="../../index.html"  accesskey="U"  >Module code</a> &raquo;</li>
                  </ol>
          </nav>
       </div>
    </div>


    <div class="content-wrapper">
      <div class="content">
        <div class="sidebar" id="agogo-sidebar">
            
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/Logo_Bravis_h.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
        </div>
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for braviz.readAndFilter.user_data</h1><div class="highlight"><pre>
<span class="c">##############################################################################</span>
<span class="c">#    Braviz, Brain Data interactive visualization                            #</span>
<span class="c">#    Copyright (C) 2014  Diego Angulo                                        #</span>
<span class="c">#                                                                            #</span>
<span class="c">#    This program is free software: you can redistribute it and/or modify    #</span>
<span class="c">#    it under the terms of the GNU Lesser General Public License as          #</span>
<span class="c">#    published by  the Free Software Foundation, either version 3 of the     #</span>
<span class="c">#    License, or (at your option) any later version.                         #</span>
<span class="c">#                                                                            #</span>
<span class="c">#    This program is distributed in the hope that it will be useful,         #</span>
<span class="c">#    but WITHOUT ANY WARRANTY; without even the implied warranty of          #</span>
<span class="c">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the           #</span>
<span class="c">#    GNU Lesser General Public License for more details.                     #</span>
<span class="c">#                                                                            #</span>
<span class="c">#    You should have received a copy of the GNU Lesser General Public License#</span>
<span class="c">#    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.   #</span>
<span class="c">##############################################################################</span>


<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;Diego&#39;</span>

<span class="kn">from</span> <span class="nn">pandas.io</span> <span class="kn">import</span> <span class="n">sql</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">cPickle</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">braviz.readAndFilter</span>
<span class="kn">from</span> <span class="nn">braviz.readAndFilter.tabular_data</span> <span class="kn">import</span> <span class="n">_get_connection</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>


<div class="viewcode-block" id="save_scenario"><a class="viewcode-back" href="../../../library/user_data.html#braviz.readAndFilter.user_data.save_scenario">[docs]</a><span class="k">def</span> <span class="nf">save_scenario</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">scenario_name</span><span class="p">,</span> <span class="n">scenario_description</span><span class="p">,</span> <span class="n">scenario_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save application state</span>

<span class="sd">    Args:</span>
<span class="sd">        application (str) : Name of application script (without extension)</span>
<span class="sd">        scenario_name (str) : Name for the scenario</span>
<span class="sd">        scenario_description (str) : Description for the scenario</span>
<span class="sd">        scenario_data (dict) : Appliation state</span>

<span class="sd">    Returns:</span>
<span class="sd">        The database id of the saved scenario. Use this to save the corresponding screen-shot</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scenario_data</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">scenario_data</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">scenario_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">scenario_data</span> <span class="o">=</span> <span class="nb">buffer</span><span class="p">(</span><span class="n">scenario_data</span><span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">_get_connection</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;INSERT  OR ABORT INTO scenarios</span>
<span class="s">    (app_idx,scn_name,scn_desc,scn_data)</span>
<span class="s">    VALUES ( (SELECT app_idx FROM applications WHERE exec_name == ?),</span>
<span class="s">    ?,?,?)&quot;&quot;&quot;</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">scenario_name</span><span class="p">,</span> <span class="n">scenario_description</span><span class="p">,</span> <span class="n">scenario_data</span><span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">lastrowid</span>
    <span class="k">return</span> <span class="n">res</span>

</div>
<div class="viewcode-block" id="update_scenario"><a class="viewcode-back" href="../../../library/user_data.html#braviz.readAndFilter.user_data.update_scenario">[docs]</a><span class="k">def</span> <span class="nf">update_scenario</span><span class="p">(</span><span class="n">scenario_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">scenario_data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">application</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update scenario information in the database</span>

<span class="sd">    Args:</span>
<span class="sd">        scenario_id (int) : Scenario id</span>
<span class="sd">        name (str) : Optional, new name for the scenario</span>
<span class="sd">        description (str) : Optional, new description for the scenario</span>
<span class="sd">        scenario_data (dict) : Optional, new application state dictionary</span>
<span class="sd">        application (str) : Optional, new application script name, without extension</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">_get_connection</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s">&quot;UPDATE scenarios SET scn_name = ? WHERE scn_id = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">scenario_id</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s">&quot;UPDATE scenarios SET scn_desc = ? WHERE scn_id = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">scenario_id</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">scenario_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">scenario_data</span> <span class="o">=</span> <span class="nb">buffer</span><span class="p">(</span><span class="n">cPickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">scenario_data</span><span class="p">))</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s">&quot;UPDATE scenarios SET scn_data = ? WHERE scn_id = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">scenario_data</span><span class="p">,</span> <span class="n">scenario_id</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">application</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;UPDATE scenarios SET app_idx = (SELECT app_idx FROM applications WHERE exec_name == ?) WHERE scn_id = ?&quot;</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">scenario_id</span><span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="get_scenarios_data_frame"><a class="viewcode-back" href="../../../library/user_data.html#braviz.readAndFilter.user_data.get_scenarios_data_frame">[docs]</a><span class="k">def</span> <span class="nf">get_scenarios_data_frame</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get available scenarios</span>

<span class="sd">    Args:</span>
<span class="sd">        app_name (str) : Optional, restrict list to a given application, it should be the base name of the</span>
<span class="sd">            application script</span>
<span class="sd">    Returns:</span>
<span class="sd">        :class:`~pandas.DataFrame` with columns for date, name and description. The index will be scenario indexes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">_get_connection</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">app_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT scn_id,datetime(scn_date,&#39;localtime&#39;) as scn_date,scn_name,scn_desc FROM scenarios&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s">&quot;scn_id&quot;</span><span class="p">,</span> <span class="n">coerce_float</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        SELECT scn_id, datetime(scn_date,&#39;localtime&#39;) as scn_date ,scn_name,scn_desc</span>
<span class="s">        FROM scenarios NATURAL JOIN applications WHERE exec_name = ?</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span>
            <span class="n">q</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s">&quot;scn_id&quot;</span><span class="p">,</span> <span class="n">coerce_float</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="n">app_name</span><span class="p">,))</span>
    <span class="n">data</span><span class="p">[</span><span class="s">&quot;scn_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&quot;scn_date&quot;</span><span class="p">],</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>

</div>
<span class="k">def</span> <span class="nf">_get_scenario_data</span><span class="p">(</span><span class="n">scn_id</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">_get_connection</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT scn_data FROM scenarios WHERE scn_id = ?&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">scn_id</span><span class="p">,))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;scenario not found&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;scenario not found&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<div class="viewcode-block" id="get_scenario_data_dict"><a class="viewcode-back" href="../../../library/user_data.html#braviz.readAndFilter.user_data.get_scenario_data_dict">[docs]</a><span class="k">def</span> <span class="nf">get_scenario_data_dict</span><span class="p">(</span><span class="n">scn_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get application state dict from the database</span>

<span class="sd">    Args:</span>
<span class="sd">        scn_id (int) : Scenario id</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with application state</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">_get_scenario_data</span><span class="p">(</span><span class="n">scn_id</span><span class="p">)</span>
    <span class="n">scn_dict</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">scn_dict</span>

</div>
<div class="viewcode-block" id="link_var_scenario"><a class="viewcode-back" href="../../../library/user_data.html#braviz.readAndFilter.user_data.link_var_scenario">[docs]</a><span class="k">def</span> <span class="nf">link_var_scenario</span><span class="p">(</span><span class="n">var_idx</span><span class="p">,</span> <span class="n">scn_idx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Links a variable to a scenario</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx (int) : Variable index</span>
<span class="sd">        scn_idx (int) : Scenario index</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">_get_connection</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;INSERT INTO vars_scenarios VALUES (?,?)&quot;</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">var_idx</span><span class="p">,</span> <span class="n">scn_idx</span><span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="get_variable_scenarios"><a class="viewcode-back" href="../../../library/user_data.html#braviz.readAndFilter.user_data.get_variable_scenarios">[docs]</a><span class="k">def</span> <span class="nf">get_variable_scenarios</span><span class="p">(</span><span class="n">var_idx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get scenarios linked to a variable</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx (int) : Variable index</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary whose keys are scenario ids and values are scenario_names for scenarios linked to the</span>
<span class="sd">            given variable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">_get_connection</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT scn_id,scn_name FROM scenarios NATURAL JOIN vars_scenarios WHERE var_idx = ?&quot;</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">var_idx</span><span class="p">,))</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>

</div>
<div class="viewcode-block" id="count_variable_scenarios"><a class="viewcode-back" href="../../../library/user_data.html#braviz.readAndFilter.user_data.count_variable_scenarios">[docs]</a><span class="k">def</span> <span class="nf">count_variable_scenarios</span><span class="p">(</span><span class="n">var_idx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the amount of scenarios linked to a given variable</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx (int) : Variable index</span>

<span class="sd">    Returns:</span>
<span class="sd">        The number of scenarios linked to the given variable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">_get_connection</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT count(*) FROM vars_scenarios WHERE var_idx == ?;&quot;</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">var_idx</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="save_sub_sample"><a class="viewcode-back" href="../../../library/user_data.html#braviz.readAndFilter.user_data.save_sub_sample">[docs]</a><span class="k">def</span> <span class="nf">save_sub_sample</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save a sub sample into the database</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str) : Name for the subsample</span>
<span class="sd">        elements (set) : Subjects in the subsample</span>
<span class="sd">        description (str) : Description of the subsample</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
    <span class="n">str_data</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">str_data</span> <span class="o">=</span> <span class="nb">buffer</span><span class="p">(</span><span class="n">str_data</span><span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">_get_connection</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;INSERT INTO subj_samples (sample_name, sample_desc, sample_data, sample_size) VALUES (?,?,?,?)&quot;</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">str_data</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="get_comment"><a class="viewcode-back" href="../../../library/user_data.html#braviz.readAndFilter.user_data.get_comment">[docs]</a><span class="k">def</span> <span class="nf">get_comment</span><span class="p">(</span><span class="n">subj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the comment about a subject</span>

<span class="sd">    Args:</span>
<span class="sd">        subj : Subject id</span>

<span class="sd">    Returns:</span>
<span class="sd">        A string with the comment about the subject</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">_get_connection</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT comment FROM subj_comments WHERE subject = ?&quot;</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">subj</span><span class="p">,))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="update_comment"><a class="viewcode-back" href="../../../library/user_data.html#braviz.readAndFilter.user_data.update_comment">[docs]</a><span class="k">def</span> <span class="nf">update_comment</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="n">comment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the comment about a subject</span>

<span class="sd">    Args:</span>
<span class="sd">        subj : Subject id</span>
<span class="sd">        comment (str) : subject comment</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">_get_connection</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;INSERT OR REPLACE into subj_comments (subject,comment) VALUES (?,?)&quot;</span>
    <span class="k">with</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="n">comment</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="get_samples_df"><a class="viewcode-back" href="../../../library/user_data.html#braviz.readAndFilter.user_data.get_samples_df">[docs]</a><span class="k">def</span> <span class="nf">get_samples_df</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get available samples</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame : A class:`~pandas.DataFrame` with columns for sample name, sample description, and sample size;</span>
<span class="sd">        indexed by the sample index</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">_get_connection</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT sample_idx, sample_name, sample_desc, sample_size FROM subj_samples&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s">&quot;sample_idx&quot;</span><span class="p">,</span> <span class="n">coerce_float</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>

</div>
<div class="viewcode-block" id="sample_name_existst"><a class="viewcode-back" href="../../../library/user_data.html#braviz.readAndFilter.user_data.sample_name_existst">[docs]</a><span class="k">def</span> <span class="nf">sample_name_existst</span><span class="p">(</span><span class="n">sample_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a sample with a given name exists</span>

<span class="sd">    Args:</span>
<span class="sd">        sample_name (str) : Sample name</span>

<span class="sd">    Returns:</span>
<span class="sd">        ``True`` if a sample with this name exists in the database, ``False`` otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">_get_connection</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT count(*) FROM subj_samples WHERE sample_name = ?&quot;</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">sample_name</span><span class="p">,))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>

</div>
<div class="viewcode-block" id="get_sample_data"><a class="viewcode-back" href="../../../library/user_data.html#braviz.readAndFilter.user_data.get_sample_data">[docs]</a><span class="k">def</span> <span class="nf">get_sample_data</span><span class="p">(</span><span class="n">sample_idx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the sample data from the database</span>

<span class="sd">    Args:</span>
<span class="sd">        sample_idx (int) :  Sample id</span>

<span class="sd">    Returns:</span>
<span class="sd">        The set of subjects in the sample</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">_get_connection</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT sample_data FROM subj_samples WHERE sample_idx = ?&quot;</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">sample_idx</span><span class="p">,))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Invalid sample index&quot;</span><span class="p">)</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data_str</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">data</span>

</div>
<div class="viewcode-block" id="delete_sample"><a class="viewcode-back" href="../../../library/user_data.html#braviz.readAndFilter.user_data.delete_sample">[docs]</a><span class="k">def</span> <span class="nf">delete_sample</span><span class="p">(</span><span class="n">sample_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete a sample from the database</span>

<span class="sd">    Args:</span>
<span class="sd">        sample_id (int) :  Sample id</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">_get_connection</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;DELETE FROM subj_samples WHERE sample_idx = ?&quot;</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sample_id</span><span class="p">),))</span>

</div>
<div class="viewcode-block" id="delete_scenario"><a class="viewcode-back" href="../../../library/user_data.html#braviz.readAndFilter.user_data.delete_scenario">[docs]</a><span class="k">def</span> <span class="nf">delete_scenario</span><span class="p">(</span><span class="n">scn_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete a scenario from the database</span>

<span class="sd">    It is also unlinked from variables, and if a screenshot is found it is deleted. This is not reversible.</span>

<span class="sd">    Args:</span>
<span class="sd">        scn_id (int) :  Scenario id</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">_get_connection</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">conn</span><span class="p">:</span>
            <span class="c"># delete vars_scenarios</span>
            <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;DELETE FROM vars_scenarios WHERE scn_id = ?&quot;</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">scn_id</span><span class="p">,))</span>
            <span class="c"># delete scenario</span>
            <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;DELETE FROM scenarios WHERE scn_id = ?&quot;</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">scn_id</span><span class="p">,))</span>
    <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;DataBase not modified&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># delete screenshot</span>
        <span class="n">scenario_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">braviz</span><span class="o">.</span><span class="n">readAndFilter</span><span class="o">.</span><span class="n">braviz_auto_dynamic_data_root</span><span class="p">(),</span> <span class="s">&quot;braviz_data&quot;</span><span class="p">,</span> <span class="s">&quot;scenarios&quot;</span><span class="p">)</span>
        <span class="n">scenario_name</span> <span class="o">=</span> <span class="s">&quot;scenario_</span><span class="si">%d</span><span class="s">.png&quot;</span> <span class="o">%</span> <span class="n">scn_id</span>
        <span class="n">full_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scenario_dir</span><span class="p">,</span> <span class="n">scenario_name</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">full_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">full_name</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">full_name</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
        </div>

        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          
                

                

                

          
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
        &copy; Copyright 2014, Diego Angulo.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>







        
  </body>
</html>