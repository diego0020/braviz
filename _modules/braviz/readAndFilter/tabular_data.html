<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>braviz.readAndFilter.tabular_data &mdash; Braviz Documentation</title>
    
    <link rel="stylesheet" href="../../../_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.3b',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/fold_classes.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
    <link rel="top" title="Braviz Documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    
    <div class="header-wrapper">
      <div class="header">
          <p class="logo"><a href="../../../index.html">
            <img class="logo" src="../../../_static/Logo_Bravis_h.png" alt="Logo"/>
          </a></p>
          <!--
        <div class="headertitle"><a
          href="../../../index.html"> Documentation </a></div>
          -->
          <nav class="parents">
              <ol>
        <li><a href="../../../index.html"> Home </a> &raquo;</li>
          <li><a href="../../index.html"  accesskey="U"  >Module code</a> &raquo;</li>
                  </ol>
          </nav>
       </div>
    </div>


    <div class="content-wrapper">
      <div class="content">
        <div class="sidebar" id="agogo-sidebar">
            
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/Logo_Bravis_h.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
        </div>
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for braviz.readAndFilter.tabular_data</h1><div class="highlight"><pre>
<span class="c"># #############################################################################</span>
<span class="c">#    Braviz, Brain Data interactive visualization                            #</span>
<span class="c">#    Copyright (C) 2014  Diego Angulo                                        #</span>
<span class="c">#                                                                            #</span>
<span class="c">#    This program is free software: you can redistribute it and/or modify    #</span>
<span class="c">#    it under the terms of the GNU Lesser General Public License as          #</span>
<span class="c">#    published by  the Free Software Foundation, either version 3 of the     #</span>
<span class="c">#    License, or (at your option) any later version.                         #</span>
<span class="c">#                                                                            #</span>
<span class="c">#    This program is distributed in the hope that it will be useful,         #</span>
<span class="c">#    but WITHOUT ANY WARRANTY; without even the implied warranty of          #</span>
<span class="c">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the           #</span>
<span class="c">#    GNU Lesser General Public License for more details.                     #</span>
<span class="c">#                                                                            #</span>
<span class="c">#    You should have received a copy of the GNU Lesser General Public License#</span>
<span class="c">#    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.   #</span>
<span class="c">##############################################################################</span>


<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">izip</span><span class="p">,</span> <span class="n">repeat</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">pandas.io</span> <span class="kn">import</span> <span class="n">sql</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">braviz</span>
<span class="kn">from</span> <span class="nn">braviz.utilities</span> <span class="kn">import</span> <span class="n">remove_non_ascii</span><span class="p">,</span> <span class="n">show_error</span>
<span class="kn">from</span> <span class="nn">braviz.readAndFilter.config_file</span> <span class="kn">import</span> <span class="n">get_apps_config</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;Diego&#39;</span>

<span class="n">LATERALITY</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">LEFT_HANDED</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">UBICAC</span> <span class="o">=</span> <span class="bp">None</span>

<span class="n">_connections</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get_connection</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the sqlite3 connection object for this thread.</span>

<span class="sd">    Also initializes module variables LATERALITY, LEFT_HANDED and UBICAC</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_connections</span>
    <span class="k">global</span> <span class="n">LATERALITY</span><span class="p">,</span> <span class="n">LEFT_HANDED</span>

    <span class="n">thread_id</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span>
    <span class="n">connection_obj</span> <span class="o">=</span> <span class="n">_connections</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">thread_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">connection_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">connection_obj</span>

    <span class="n">data_root</span> <span class="o">=</span> <span class="n">braviz</span><span class="o">.</span><span class="n">readAndFilter</span><span class="o">.</span><span class="n">braviz_auto_dynamic_data_root</span><span class="p">()</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_root</span><span class="p">,</span> <span class="s">&quot;braviz_data&quot;</span><span class="p">)</span>
    <span class="n">db_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;tabular_data.sqlite&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">data_root</span><span class="p">):</span>
        <span class="n">show_error</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t open database file</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t open database location:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">path</span><span class="p">)</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span>  <span class="n">detect_types</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;pragma busy_timeout = 10000&quot;</span><span class="p">)</span>
    <span class="n">_connections</span><span class="p">[</span><span class="n">thread_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span>
    <span class="k">if</span> <span class="n">LATERALITY</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_conf</span> <span class="o">=</span> <span class="n">get_apps_config</span><span class="p">()</span>
            <span class="n">_lat_name</span><span class="p">,</span> <span class="n">_left_labell</span> <span class="o">=</span> <span class="n">_conf</span><span class="o">.</span><span class="n">get_laterality</span><span class="p">()</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s">&quot;SELECT var_idx from variables where var_name = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">_lat_name</span><span class="p">,))</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="n">LATERALITY</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">LEFT_HANDED</span> <span class="o">=</span> <span class="n">_left_labell</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">conn</span>



<div class="viewcode-block" id="get_variables"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.get_variables">[docs]</a><span class="k">def</span> <span class="nf">get_variables</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets available variables</span>

<span class="sd">    Args:</span>
<span class="sd">        mask (str) : If not None, limit answer to results whose name match the given mask (sql ``like`` syntax)</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`pandas.DataFrame` with variable indexes as index, and a single column with variable names</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span>
            <span class="s">&quot;SELECT var_idx, var_name from variables;&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s">&quot;var_idx&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s">&quot;SELECT var_idx, var_name from variables WHERE var_name like ?;&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="n">mask</span><span class="p">,),</span>
                            <span class="n">index_col</span><span class="o">=</span><span class="s">&quot;var_idx&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>
</div>
<span class="k">def</span> <span class="nf">get_variables_and_type</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets available variables</span>

<span class="sd">    Args:</span>
<span class="sd">        mask (str) : If not None, limit answer to results whose name match the given mask (sql ``like`` syntax)</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`pandas.DataFrame` with variable indexes as index, a column with variable names, and a with ``1`` for</span>
<span class="sd">            numerical values and ``0`` for nominal variables</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span>
            <span class="s">&quot;SELECT var_idx, var_name, is_real  from variables;&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s">&quot;var_idx&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s">&quot;SELECT var_idx, var_name, is_real from variables WHERE var_name like ?;&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="n">mask</span><span class="p">,),</span>
                            <span class="n">index_col</span><span class="o">=</span><span class="s">&quot;var_idx&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>



<span class="k">def</span> <span class="nf">_reset_connection</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resests existing connection for this thread</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_log_connections</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
    <span class="n">thread_id</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span>
    <span class="n">connection_obj</span> <span class="o">=</span> <span class="n">_connections</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">thread_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">connection_obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">connection_obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">_connections</span><span class="p">[</span><span class="n">thread_id</span><span class="p">]</span>


<div class="viewcode-block" id="get_laterality"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.get_laterality">[docs]</a><span class="k">def</span> <span class="nf">get_laterality</span><span class="p">(</span><span class="n">subj_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the laterality for a given subject</span>

<span class="sd">    Args:</span>
<span class="sd">        subj_id : The id of the subject</span>

<span class="sd">    Returns:</span>
<span class="sd">        &quot;l&quot; for a left handed subject, &quot;r&quot; otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">subj_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">subj_id</span><span class="p">)</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s">&quot;SELECT value FROM var_values WHERE var_idx = ? and subject = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">LATERALITY</span><span class="p">,</span> <span class="n">subj_id</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Unknown laterality&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">LEFT_HANDED</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;r&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;l&#39;</span>

</div>
<div class="viewcode-block" id="get_data_frame_by_name"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.get_data_frame_by_name">[docs]</a><span class="k">def</span> <span class="nf">get_data_frame_by_name</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A data frame containing one column for each variable name in columns</span>

<span class="sd">    Args:</span>
<span class="sd">        columns (list) : Variable names</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`pandas.DataFrame` with subject ids as index and one column for each variable</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">(</span><span class="n">columns</span><span class="p">,)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span>
        <span class="s">&quot;SELECT subject from SUBJECTS&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s">&quot;subject&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="c"># language=SQLite</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;SELECT subject, value</span>
<span class="s">        FROM subjects NATURAL JOIN var_values</span>
<span class="s">        WHERE var_idx = (SELECT var_idx FROM variables WHERE var_name = ?)</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span>
            <span class="n">query</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s">&quot;subject&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">var</span><span class="p">),),</span> <span class="n">coerce_float</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

</div>
<div class="viewcode-block" id="get_data_frame_by_index"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.get_data_frame_by_index">[docs]</a><span class="k">def</span> <span class="nf">get_data_frame_by_index</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">col_name_index</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A data frame containing one column for each variable index in columns</span>

<span class="sd">    Args:</span>
<span class="sd">        columns (list) : Variable indexes</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`pandas.DataFrame` with subject ids as index and one column for each variable</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="s">&quot;__iter__&quot;</span><span class="p">):</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">(</span><span class="n">columns</span><span class="p">,)</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span>
        <span class="s">&quot;SELECT subject from SUBJECTS&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s">&quot;subject&quot;</span><span class="p">)</span>
    <span class="n">col_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s">&quot;SELECT var_name FROM variables WHERE var_idx = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">),))</span>
        <span class="n">name1</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">col_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">col_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Var_</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">var_idx</span><span class="p">,</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">col_names</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;SELECT subject, value</span>
<span class="s">        FROM subjects NATURAL JOIN var_values</span>
<span class="s">        WHERE var_idx = ?</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span>
            <span class="n">query</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s">&quot;subject&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">var_idx</span><span class="p">),),</span> <span class="n">coerce_float</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col_name_index</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">var_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>

</div>
<div class="viewcode-block" id="is_variable_real"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.is_variable_real">[docs]</a><span class="k">def</span> <span class="nf">is_variable_real</span><span class="p">(</span><span class="n">var_idx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find if the variable is real or nominal</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx (int) : Variable index</span>

<span class="sd">    Returns:</span>
<span class="sd">        ``False`` if the variable is Nominal,</span>
<span class="sd">        ``True`` otherwise</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s">&quot;SELECT is_real FROM variables WHERE var_idx = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">var_idx</span><span class="p">),))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">True</span>

</div>
<div class="viewcode-block" id="does_variable_name_exists"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.does_variable_name_exists">[docs]</a><span class="k">def</span> <span class="nf">does_variable_name_exists</span><span class="p">(</span><span class="n">var_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find if the a variable with the given name exists in the database</span>

<span class="sd">    Args:</span>
<span class="sd">        var_name (str) : Variable name</span>

<span class="sd">    Returns:</span>
<span class="sd">        ``True`` if a variable with the given name exists,</span>
<span class="sd">        ``False`` otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s">&quot;SELECT count(*) FROM variables WHERE var_name = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">var_name</span><span class="p">,))</span>
    <span class="k">return</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">True</span>

</div>
<div class="viewcode-block" id="is_variable_nominal"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.is_variable_nominal">[docs]</a><span class="k">def</span> <span class="nf">is_variable_nominal</span><span class="p">(</span><span class="n">var_idx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find if the variable is real or nominal</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx (int) : Variable index</span>

<span class="sd">    Returns:</span>
<span class="sd">        ``True`` if the variable is Nominal,</span>
<span class="sd">        ``False`` otherwise</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="ow">not</span> <span class="n">is_variable_real</span><span class="p">(</span><span class="n">var_idx</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="is_variable_name_real"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.is_variable_name_real">[docs]</a><span class="k">def</span> <span class="nf">is_variable_name_real</span><span class="p">(</span><span class="n">var_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find if the variable is real or nominal</span>

<span class="sd">    Args:</span>
<span class="sd">        var_name (str) : Variable name</span>

<span class="sd">    Returns:</span>
<span class="sd">        ``False`` if the variable is Nominal,</span>
<span class="sd">        ``True`` otherwise</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s">&quot;SELECT is_real FROM variables  WHERE var_name = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">var_name</span><span class="p">),))</span>
    <span class="k">return</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">True</span>

</div>
<div class="viewcode-block" id="is_variable_name_nominal"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.is_variable_name_nominal">[docs]</a><span class="k">def</span> <span class="nf">is_variable_name_nominal</span><span class="p">(</span><span class="n">var_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find if the variable is real or nominal</span>

<span class="sd">    Args:</span>
<span class="sd">        var_name (str) : Variable name</span>

<span class="sd">    Return:</span>
<span class="sd">        ``True`` if the variable is Nominal,</span>
<span class="sd">        ``False`` otherwise</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">is_variable_name_real</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="are_variables_real"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.are_variables_real">[docs]</a><span class="k">def</span> <span class="nf">are_variables_real</span><span class="p">(</span><span class="n">var_idxs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For each variable in a list, find if it is real</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idxs (list) : variable indexes</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary with variable indexes as keys, and booleans as values as in</span>
<span class="sd">        :func:`~.is_variable_real`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="n">is_variable_real</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">var_idxs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="are_variables_nominal"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.are_variables_nominal">[docs]</a><span class="k">def</span> <span class="nf">are_variables_nominal</span><span class="p">(</span><span class="n">var_idxs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For each variable in a list, find if it is real</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idxs (list) : variable indexes</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary with variable indexes as keys, and booleans as values as in</span>
<span class="sd">        :func:`~.is_variable_nominal`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="ow">not</span> <span class="n">is_variable_real</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">var_idxs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="are_variables_names_real"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.are_variables_names_real">[docs]</a><span class="k">def</span> <span class="nf">are_variables_names_real</span><span class="p">(</span><span class="n">var_names</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For each variable in a list, find if it is real</span>

<span class="sd">    Args:</span>
<span class="sd">        var_names (list) : variable names</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary with variable names as keys, and booleans as values as in</span>
<span class="sd">        :func:`~.is_variable_name_real`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">is_variable_name_real</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="are_variables_names_nominal"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.are_variables_names_nominal">[docs]</a><span class="k">def</span> <span class="nf">are_variables_names_nominal</span><span class="p">(</span><span class="n">var_names</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For each variable in a list, find if it is real</span>

<span class="sd">    Args:</span>
<span class="sd">        var_names (list) : variable names</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary with variable names as keys, and booleans as values as in</span>
<span class="sd">        :func:`~.is_variable_name_nominal`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="ow">not</span> <span class="n">is_variable_name_nominal</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="get_labels_dict"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.get_labels_dict">[docs]</a><span class="k">def</span> <span class="nf">get_labels_dict</span><span class="p">(</span><span class="n">var_idx</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map numerical labels to strings in nominal variables</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx (int) : Variable Index</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary with numerical labels as keys, and the text for each label as</span>
<span class="sd">        values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">var_idx</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">:</span>
        <span class="k">if</span> <span class="n">var_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;var_idx or var_name is required&quot;</span><span class="p">)</span>
        <span class="n">var_idx</span> <span class="o">=</span> <span class="n">get_var_idx</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">    SELECT label2, name</span>
<span class="s">    from</span>
<span class="s">    (</span>
<span class="s">    SELECT  distinct value as label2, var_idx as var_idx2</span>
<span class="s">    FROM var_values</span>
<span class="s">    WHERE var_idx = ?</span>
<span class="s">    ) left outer join</span>
<span class="s">    nom_meta ON (nom_meta.label = label2 and var_idx2 = nom_meta.var_idx)</span>

<span class="s">    UNION</span>
<span class="s">    SELECT label as label2, name FROM nom_meta WHERE var_idx =  ?</span>

<span class="s">    ORDER BY label2</span>
<span class="s">    &quot;&quot;&quot;</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">var_idx</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">var_idx</span><span class="p">),))</span>
    <span class="n">ans_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ans_dict</span>

</div>
<div class="viewcode-block" id="get_labels_dict_by_name"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.get_labels_dict_by_name">[docs]</a><span class="k">def</span> <span class="nf">get_labels_dict_by_name</span><span class="p">(</span><span class="n">var_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map numerical labels to strings in nominal variables</span>

<span class="sd">    Args:</span>
<span class="sd">        var_name (str) : Variable name</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary with numerical labels as keys, and the text for each label as</span>
<span class="sd">        values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        SELECT label2, name</span>
<span class="s">        from</span>
<span class="s">        (</span>
<span class="s">        SELECT  distinct value as label2, variables.var_idx as var_idx2</span>
<span class="s">        FROM variables natural join var_values</span>
<span class="s">        WHERE variables.var_name = ?</span>
<span class="s">        ) left outer join</span>
<span class="s">        nom_meta ON (nom_meta.label = label2 and var_idx2 = nom_meta.var_idx)</span>

<span class="s">        UNION</span>
<span class="s">        SELECT label as label2, name FROM nom_meta WHERE var_idx =  (select var_idx from variables WHERE var_name = ?)</span>

<span class="s">        ORDER BY label2</span>
<span class="s">        &quot;&quot;&quot;</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">var_name</span><span class="p">),</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">var_name</span><span class="p">)))</span>
    <span class="n">ans_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">ans_dict</span>

</div>
<div class="viewcode-block" id="get_var_name"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.get_var_name">[docs]</a><span class="k">def</span> <span class="nf">get_var_name</span><span class="p">(</span><span class="n">var_idx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Name of variable with given index</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx (int) : Variable index</span>

<span class="sd">    Returns:</span>
<span class="sd">        Variable name if it exists, ``&quot;?&quot;`` otherwise</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s">&quot;SELECT var_name FROM variables WHERE var_idx = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">var_idx</span><span class="p">),))</span>
    <span class="n">ans</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ans</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;?&quot;</span>
    <span class="k">return</span> <span class="n">ans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="get_var_idx"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.get_var_idx">[docs]</a><span class="k">def</span> <span class="nf">get_var_idx</span><span class="p">(</span><span class="n">var_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Index of variable with given name</span>

<span class="sd">    Args:</span>
<span class="sd">        var_name (str) : Variable name</span>

<span class="sd">    Returns:</span>
<span class="sd">        Index of variable with the given name if it exists, ``None`` otherwise</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s">&quot;SELECT var_idx FROM variables WHERE var_name = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">var_name</span><span class="p">),))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="get_maximum_value"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.get_maximum_value">[docs]</a><span class="k">def</span> <span class="nf">get_maximum_value</span><span class="p">(</span><span class="n">var_idx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the maximum value for a real variable as recorded in meta-data</span>

<span class="sd">    If there is no metadata, it is calculated from the existing values</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx (int) : Variable index</span>

<span class="sd">    Returns:</span>
<span class="sd">        Maximum values as recorded in the metadata,</span>
<span class="sd">         if there is no metadata, maximum from existing values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s">&quot;SELECT max_val FROM ratio_meta WHERE var_idx = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">var_idx</span><span class="p">),))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;select MAX(value) from (select * from var_values where value != &quot;nan&quot;)</span>
<span class="s">        where var_idx = ? group by var_idx&quot;&quot;&quot;</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">var_idx</span><span class="p">),))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">res</span>

</div>
<div class="viewcode-block" id="get_minimum_value"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.get_minimum_value">[docs]</a><span class="k">def</span> <span class="nf">get_minimum_value</span><span class="p">(</span><span class="n">var_idx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the minimum value for a real variable as recorded in meta-data</span>

<span class="sd">    If there is no metadata, it is calculated from the existing values</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx (int) : Variable index</span>

<span class="sd">    Returns:</span>
<span class="sd">        Minimum values as recorded in the metadata,</span>
<span class="sd">         if there is no metadata, minimum from existing values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s">&quot;SELECT min_val FROM ratio_meta WHERE var_idx = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">var_idx</span><span class="p">),))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;select Min(value) from (select * from var_values where value != &quot;nan&quot;)</span>
<span class="s">        where var_idx = ? group by var_idx&quot;&quot;&quot;</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">var_idx</span><span class="p">),))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">res</span>

</div>
<div class="viewcode-block" id="get_min_max_values"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.get_min_max_values">[docs]</a><span class="k">def</span> <span class="nf">get_min_max_values</span><span class="p">(</span><span class="n">var_idx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the minimum and maximum values for a real variable as recorded in meta-data</span>

<span class="sd">    If there is no metadata, they are calculated from the existing values</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx (int) : Variable index</span>

<span class="sd">    Returns:</span>
<span class="sd">        ``(min_val, max_val)``  values as recorded in the metadata,</span>
<span class="sd">         if there is no metadata, they are calculated from existing values</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s">&quot;SELECT min_val, max_val FROM ratio_meta WHERE var_idx = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">var_idx</span><span class="p">),))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;select MIN(value), MAX(value) from (select * from var_values where value != &quot;nan&quot;)</span>
<span class="s">        where var_idx = ? group by var_idx&quot;&quot;&quot;</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">var_idx</span><span class="p">),))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">res</span>

</div>
<div class="viewcode-block" id="get_min_max_values_by_name"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.get_min_max_values_by_name">[docs]</a><span class="k">def</span> <span class="nf">get_min_max_values_by_name</span><span class="p">(</span><span class="n">var_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the minimum and maximum values for a real variable as recorded in meta-data</span>

<span class="sd">    If there is no metadata, they are calculated from the existing values</span>

<span class="sd">    Args:</span>
<span class="sd">        var_name (str) : Variable name</span>

<span class="sd">    Returns:</span>
<span class="sd">        ``(min_val, max_val)``  values as recorded in the metadata,</span>
<span class="sd">         if there is no metadata, they are calculated from existing values</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT min_val, max_val FROM ratio_meta NATURAL JOIN variables WHERE var_name = ?&quot;</span><span class="p">,</span>
                       <span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">var_name</span><span class="p">),))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;select MIN(value), MAX(value) from (select * from var_values where value != &quot;nan&quot;)</span>
<span class="s">        where var_idx = (SELECT var_idx FROM variables WHERE var_name = ?) group by var_idx&quot;&quot;&quot;</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">var_name</span><span class="p">),))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">res</span>

</div>
<div class="viewcode-block" id="get_min_max_opt_values_by_name"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.get_min_max_opt_values_by_name">[docs]</a><span class="k">def</span> <span class="nf">get_min_max_opt_values_by_name</span><span class="p">(</span><span class="n">var_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the minimum, maximum and optimal values for a real variable as recorded in meta-data</span>

<span class="sd">    If there is no metadata, they are calculated from the existing values</span>

<span class="sd">    Args:</span>
<span class="sd">        var_name (str) : Variable name</span>

<span class="sd">    Returns:</span>
<span class="sd">        ``(min_val, max_val, optimum_val)``  values as recorded in the metadata,</span>
<span class="sd">         if there is no metadata, they are calculated from existing values. In this case the optimum will</span>
<span class="sd">         be the mean of existing values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT min_val, max_val, optimum_val FROM ratio_meta NATURAL JOIN variables WHERE var_name = ?&quot;</span><span class="p">,</span>
                       <span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">var_name</span><span class="p">),))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;select MIN(value), MAX(value), AVG(VALUE) from (select * from var_values where value != &quot;nan&quot;)</span>
<span class="s">        where var_idx = (SELECT var_idx FROM variables WHERE var_name = ?) group by var_idx&quot;&quot;&quot;</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">var_name</span><span class="p">),))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">res</span>

</div>
<div class="viewcode-block" id="get_subject_variables"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.get_subject_variables">[docs]</a><span class="k">def</span> <span class="nf">get_subject_variables</span><span class="p">(</span><span class="n">subj_code</span><span class="p">,</span> <span class="n">var_codes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get several values for one subjects</span>

<span class="sd">    Args:</span>
<span class="sd">        subj_code : Subject id</span>
<span class="sd">        var_codes (list) : Variable codes</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`pandas.DataFrame` with two columns: Variable name, and variable value; for each index in var_codes,</span>
<span class="sd">        which will be used as indexes in the DataFrame.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">var_codes</span><span class="p">:</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s">&quot;SELECT var_name, is_real FROM variables WHERE var_idx = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">),))</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ans</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">var_name</span><span class="p">,</span> <span class="n">is_real</span> <span class="o">=</span> <span class="s">&quot;&lt;Unexistent&gt;&quot;</span><span class="p">,</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var_name</span><span class="p">,</span> <span class="n">is_real</span> <span class="o">=</span> <span class="n">ans</span>
        <span class="k">if</span> <span class="n">subj_code</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;Nan&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">is_real</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">is_real</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT value FROM var_values WHERE var_idx = ? and subject = ?&quot;</span><span class="p">,</span>
                               <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">subj_code</span><span class="p">)))</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ans</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">ans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s">&quot;nan&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">ans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;SELECT name FROM var_values NATURAL JOIN nom_meta</span>
<span class="s">            WHERE subject = ? and var_idx = ? and var_values.value == nom_meta.label&quot;&quot;&quot;</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">subj_code</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">)))</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ans</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;?&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">ans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>
        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="n">names</span><span class="p">,</span> <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">values</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">var_codes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>

</div>
<div class="viewcode-block" id="get_subjects"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.get_subjects">[docs]</a><span class="k">def</span> <span class="nf">get_subjects</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a list subjects which exist in the database</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT subject FROM subjects ORDER BY subject&quot;</span><span class="p">)</span>
    <span class="n">subj_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">subj_list</span>

</div>
<div class="viewcode-block" id="get_var_description"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.get_var_description">[docs]</a><span class="k">def</span> <span class="nf">get_var_description</span><span class="p">(</span><span class="n">var_idx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get description for a variable</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx (int) : Variable index</span>

<span class="sd">    Returns:</span>
<span class="sd">        A string containing the description of the variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT description FROM var_descriptions WHERE var_idx = ?&quot;</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">var_idx</span><span class="p">),))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</div>
<span class="k">def</span> <span class="nf">get_descriptions_dict</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a dictionary with the descriptions of all variables</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary with variable indices as keys and description strings as values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT var_idx, description FROM var_descriptions&quot;</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">res</span>

<div class="viewcode-block" id="get_var_description_by_name"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.get_var_description_by_name">[docs]</a><span class="k">def</span> <span class="nf">get_var_description_by_name</span><span class="p">(</span><span class="n">var_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get description for a variable</span>

<span class="sd">    Args:</span>
<span class="sd">        var_name (str) : Variable name</span>

<span class="sd">    Returns:</span>
<span class="sd">        A string containing the description of the variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT description FROM var_descriptions NATURAL JOIN variables WHERE var_name = ?&quot;</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">var_name</span><span class="p">),))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="save_is_real_by_name"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.save_is_real_by_name">[docs]</a><span class="k">def</span> <span class="nf">save_is_real_by_name</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">is_real</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update variable type in the metadata</span>

<span class="sd">    Args:</span>
<span class="sd">        var_name (str) :  Variable name</span>
<span class="sd">        is_real (bool) : If True the variable will be registered as real, otherwise it will be registered as nominal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;UPDATE variables SET is_real = ? WHERE var_name = ?&quot;</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">is_real</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">var_name</span><span class="p">)))</span>


</div>
<div class="viewcode-block" id="save_is_real"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.save_is_real">[docs]</a><span class="k">def</span> <span class="nf">save_is_real</span><span class="p">(</span><span class="n">var_idx</span><span class="p">,</span> <span class="n">is_real</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update variable type in the metadata</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx (int) :  Variable index</span>
<span class="sd">        is_real (bool) : If True the variable will be registered as real, otherwise it will be registered as nominal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;UPDATE variables SET is_real = ? WHERE var_idx = ?&quot;</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">is_real</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">var_idx</span><span class="p">)))</span>


</div>
<div class="viewcode-block" id="save_real_meta_by_name"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.save_real_meta_by_name">[docs]</a><span class="k">def</span> <span class="nf">save_real_meta_by_name</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">min_value</span><span class="p">,</span> <span class="n">max_value</span><span class="p">,</span> <span class="n">opt_value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update real variables&#39; meta data</span>

<span class="sd">    Args:</span>
<span class="sd">        var_name (str) :  Variable name</span>
<span class="sd">        min_value (float) : Variables minimum value</span>
<span class="sd">        man_value (float) : Variables maximum value</span>
<span class="sd">        opt_value (float) : Variables optimum value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;INSERT OR REPLACE INTO ratio_meta</span>
<span class="s">    VALUES(</span>
<span class="s">    (SELECT var_idx FROM variables WHERE var_name = ?),</span>
<span class="s">    ? , ? , ? );</span>
<span class="s">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span>
                     <span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">min_value</span><span class="p">,</span>
                      <span class="n">max_value</span><span class="p">,</span> <span class="n">opt_value</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="save_real_meta"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.save_real_meta">[docs]</a><span class="k">def</span> <span class="nf">save_real_meta</span><span class="p">(</span><span class="n">var_idx</span><span class="p">,</span> <span class="n">min_value</span><span class="p">,</span> <span class="n">max_value</span><span class="p">,</span> <span class="n">opt_value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update real variables&#39; meta data</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx (int) :  Variable index</span>
<span class="sd">        min_value (float) : Variables minimum value</span>
<span class="sd">        man_value (float) : Variables maximum value</span>
<span class="sd">        opt_value (float) : Variables optimum value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;INSERT OR REPLACE INTO ratio_meta</span>
<span class="s">    VALUES(?, ? , ? , ? );</span>
<span class="s">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span>
                     <span class="p">(</span><span class="n">var_idx</span><span class="p">,</span> <span class="n">min_value</span><span class="p">,</span>
                      <span class="n">max_value</span><span class="p">,</span> <span class="n">opt_value</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="save_nominal_labels_by_name"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.save_nominal_labels_by_name">[docs]</a><span class="k">def</span> <span class="nf">save_nominal_labels_by_name</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">label_name_tuples</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update nominal variable labels</span>

<span class="sd">    Args:</span>
<span class="sd">        var_name (str) :  Variable name</span>
<span class="sd">        label_name_tuples (list) : List of tuples, the first component of each tuple is the numeric label, and the</span>
<span class="sd">            second component its meaning. For example ``(1, &quot;male&quot;)``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mega_tuple</span> <span class="o">=</span> <span class="p">((</span><span class="n">var_name</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">label_name_tuples</span><span class="p">)</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;INSERT OR REPLACE INTO nom_meta</span>
<span class="s">    VALUES (</span>
<span class="s">    (SELECT var_idx FROM variables WHERE var_name = ?),</span>
<span class="s">    ?, -- label</span>
<span class="s">    ? -- name</span>
<span class="s">    );</span>
<span class="s">    &quot;&quot;&quot;</span>
    <span class="n">con</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">mega_tuple</span><span class="p">)</span>
    <span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="save_nominal_labels"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.save_nominal_labels">[docs]</a><span class="k">def</span> <span class="nf">save_nominal_labels</span><span class="p">(</span><span class="n">var_idx</span><span class="p">,</span> <span class="n">label_name_tuples</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update nominal variable labels</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx (int) :  Variable index</span>
<span class="sd">        label_name_tuples (list) : List of tuples, the first component of each tuple is the numeric label, and the</span>
<span class="sd">            second component its meaning. For example ``(1, &quot;male&quot;)``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mega_tuple</span> <span class="o">=</span> <span class="p">((</span><span class="n">var_idx</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">label_name_tuples</span><span class="p">)</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;INSERT OR REPLACE INTO nom_meta</span>
<span class="s">    VALUES (</span>
<span class="s">    ?, --idx</span>
<span class="s">    ?, -- label</span>
<span class="s">    ? -- name</span>
<span class="s">    );</span>
<span class="s">    &quot;&quot;&quot;</span>
    <span class="n">con</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">mega_tuple</span><span class="p">)</span>
    <span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="save_var_description_by_name"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.save_var_description_by_name">[docs]</a><span class="k">def</span> <span class="nf">save_var_description_by_name</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save or overwrite description for a variable</span>

<span class="sd">    Args:</span>
<span class="sd">        var_name (str) : Variable Name</span>
<span class="sd">        description (str) : Variable description</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;INSERT OR REPLACE INTO var_descriptions</span>
<span class="s">    VALUES</span>
<span class="s">    ((SELECT var_idx FROM variables WHERE var_name = ?), -- var_idx</span>
<span class="s">    ?) -- desc &quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">description</span><span class="p">,))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="save_var_description"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.save_var_description">[docs]</a><span class="k">def</span> <span class="nf">save_var_description</span><span class="p">(</span><span class="n">var_idx</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save or overwrite description for a variable</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx (int) : Variable index</span>
<span class="sd">        description (str) : Variable description</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;INSERT OR REPLACE INTO var_descriptions</span>
<span class="s">    VALUES</span>
<span class="s">    (?, -- var_idx</span>
<span class="s">    ?) -- desc&quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">var_idx</span><span class="p">,</span> <span class="n">description</span><span class="p">,))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="register_new_variable"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.register_new_variable">[docs]</a><span class="k">def</span> <span class="nf">register_new_variable</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">is_real</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a new variable to the database</span>

<span class="sd">    Args:</span>
<span class="sd">        var_name (str) : Name for the new variable, should be unique</span>
<span class="sd">        is_real (bool) : Type of the new variable, ``True`` if it is real, ``False`` if it is nominal</span>

<span class="sd">    Returns:</span>
<span class="sd">        Database index of the new variable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">var_name</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_real</span><span class="p">:</span>
                <span class="n">is_real</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_real</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;INSERT INTO variables (var_name, is_real)</span>
<span class="s">                 Values (? , ?)&quot;&quot;&quot;</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">is_real</span><span class="p">))</span>
            <span class="n">row_id</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">lastrowid</span>
        <span class="k">return</span> <span class="n">row_id</span>
    <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t create new variable&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

</div>
<div class="viewcode-block" id="update_variable_values"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.update_variable_values">[docs]</a><span class="k">def</span> <span class="nf">update_variable_values</span><span class="p">(</span><span class="n">var_idx</span><span class="p">,</span> <span class="n">tuples</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates values for one variable and some subjects</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx (int) : Variable index</span>
<span class="sd">        tuples (list) : Tuples of the form ``(subject,value)`` where subject is the subject id, and value</span>
<span class="sd">            is the new value for the variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">super_tuples</span> <span class="o">=</span> <span class="p">((</span><span class="n">var_idx</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tuples</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;INSERT OR REPLACE INTO var_values VALUES (? ,?, ?)&quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">super_tuples</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="update_multiple_variable_values"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.update_multiple_variable_values">[docs]</a><span class="k">def</span> <span class="nf">update_multiple_variable_values</span><span class="p">(</span><span class="n">idx_subject_value_tuples</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates values for variables and subjects</span>

<span class="sd">    Args:</span>
<span class="sd">        idx_subject_value_tuples (list) : Tuples of the form ``(var_idx, subject, value)`` where var_idx and subject</span>
<span class="sd">            are the variable and subject for whom the new value will be set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;INSERT OR REPLACE INTO var_values VALUES (? ,?, ?)&quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">idx_subject_value_tuples</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="update_variable_value"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.update_variable_value">[docs]</a><span class="k">def</span> <span class="nf">update_variable_value</span><span class="p">(</span><span class="n">var_idx</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates a single value for a variable and a subject</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx (int) : Variable index</span>
<span class="sd">        subject : Subject id</span>
<span class="sd">        new_value : Value to be saved</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;INSERT OR REPLACE INTO var_values VALUES (? ,?, ?)&quot;&quot;&quot;</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">var_idx</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">subject</span><span class="p">),</span> <span class="n">new_value</span><span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="get_var_value"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.get_var_value">[docs]</a><span class="k">def</span> <span class="nf">get_var_value</span><span class="p">(</span><span class="n">var_idx</span><span class="p">,</span> <span class="n">subject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a single variable value</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx (int) : Variable index</span>
<span class="sd">        subject : Subject id</span>

<span class="sd">    Returns:</span>
<span class="sd">        The numerical value for the given variable and subject</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT value FROM var_values WHERE var_idx = ? and subject = ?&quot;</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">var_idx</span><span class="p">,</span> <span class="n">subject</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> not found for subject </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var_idx</span><span class="p">,</span> <span class="n">subject</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> not found for subject </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var_idx</span><span class="p">,</span> <span class="n">subject</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="get_variable_normal_range"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.get_variable_normal_range">[docs]</a><span class="k">def</span> <span class="nf">get_variable_normal_range</span><span class="p">(</span><span class="n">var_idx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the range of a given variable for the reference population</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx : Variable index</span>

<span class="sd">    Returns:</span>
<span class="sd">        ``(min_val, max_val)`` calculated over the values the variable takes in the reference population.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">UBICAC</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="c"># minimum,maximum</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;SELECT min(var_values.value), max(cast( var_values.value as numeric)) from var_values JOIN var_values as var_values2</span>
<span class="s">     WHERE var_values.subject == var_values2.subject and var_values2.var_idx == ? and var_values2.value == ?</span>
<span class="s">     and var_values.var_idx = ? and var_values.value notnull</span>
<span class="s">        &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">UBICAC</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">get_apps_config</span><span class="p">()</span>
        <span class="n">var_name</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get_reference_population</span><span class="p">()</span>
        <span class="n">u_var_idx</span> <span class="o">=</span> <span class="n">get_var_idx</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>
        <span class="n">UBICAC</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_var_idx</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">UBICAC</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">UBICAC</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">var_idx</span><span class="p">))</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s">&quot;nan&quot;</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="s">&quot;nan&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s">&#39;nan&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s">&#39;nan&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>

</div>
<span class="k">def</span> <span class="nf">_float_or_nan</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s">&quot;nan&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">v</span>


<div class="viewcode-block" id="add_data_frame"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.add_data_frame">[docs]</a><span class="k">def</span> <span class="nf">add_data_frame</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inserts a whole dataframe into the database</span>

<span class="sd">    Args:</span>
<span class="sd">        df ( pandas.DataFrame ) : DataFrame with subject ids as index, and one column for each new variable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">remove_non_ascii</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span>
    <span class="n">tot_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">subjs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_values</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c"># check if there are new subjects</span>
    <span class="k">with</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;INSERT OR IGNORE INTO subjects VALUES(?)&quot;</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">((</span><span class="n">s</span><span class="p">,)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">subjs</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> / </span><span class="si">%d</span><span class="s"> : </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tot_cols</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">does_variable_name_exists</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                <span class="n">var_idx</span> <span class="o">=</span> <span class="n">get_var_idx</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">q1</span> <span class="o">=</span> <span class="s">&quot;INSERT INTO variables (var_name) VALUES (?)&quot;</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="p">(</span><span class="n">c</span><span class="p">,))</span>
                <span class="n">var_idx</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">lastrowid</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">get_values</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">_float_or_nan</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">get_values</span><span class="p">()]</span>
            <span class="n">q2</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;INSERT OR REPLACE INTO var_values (var_idx,subject,value)</span>
<span class="s">            VALUES ( ?, ?,?)&quot;&quot;&quot;</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">q2</span><span class="p">,</span> <span class="n">izip</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">var_idx</span><span class="p">),</span> <span class="n">subjs</span><span class="p">,</span> <span class="n">vals</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;done&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="recursive_delete_variable"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.recursive_delete_variable">[docs]</a><span class="k">def</span> <span class="nf">recursive_delete_variable</span><span class="p">(</span><span class="n">var_idx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes a variable from all tables</span>

<span class="sd">    .. warning::</span>

<span class="sd">        This may affect large amounts of information and can&#39;t be reversed</span>

<span class="sd">    Some references to the variable may remain in scenario data or outside the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx (int) : Variable index</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">conn</span><span class="p">:</span>
            <span class="c"># delete values</span>
            <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;DELETE FROM var_values WHERE var_idx = ?&quot;</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">var_idx</span><span class="p">,))</span>
            <span class="c"># delete meta</span>
            <span class="n">q1</span> <span class="o">=</span> <span class="s">&quot;DELETE FROM nom_meta WHERE var_idx = ?&quot;</span>
            <span class="n">q2</span> <span class="o">=</span> <span class="s">&quot;DELETE FROM ratio_meta WHERE var_idx = ?&quot;</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="p">(</span><span class="n">var_idx</span><span class="p">,))</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q2</span><span class="p">,</span> <span class="p">(</span><span class="n">var_idx</span><span class="p">,))</span>
            <span class="c"># delete description</span>
            <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;DELETE FROM var_descriptions WHERE var_idx = ?&quot;</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">var_idx</span><span class="p">,))</span>
            <span class="c"># delete vars_scenarios</span>
            <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;DELETE FROM vars_scenarios WHERE var_idx = ?&quot;</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">var_idx</span><span class="p">,))</span>
            <span class="c"># delete variable</span>
            <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;DELETE FROM variables WHERE var_idx = ?&quot;</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">var_idx</span><span class="p">,))</span>
    <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;DataBase not modified&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Done&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="recursive_delete_subject"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.recursive_delete_subject">[docs]</a><span class="k">def</span> <span class="nf">recursive_delete_subject</span><span class="p">(</span><span class="n">subject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes a subject from the database</span>

<span class="sd">    .. warning::</span>

<span class="sd">        This may affect large amounts of information and can&#39;t be reversed</span>

<span class="sd">    Some references to the variable may remain in scenario data, subsamples or outside the database.</span>
<span class="sd">    There must not exist any geometrical structure (see :mod:`~braviz.readAndFilter.geom_db`) associated with</span>
<span class="sd">    the subject, if that is the case the operation will be aborted without modifying the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        var_idx (int) : Variable index</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">conn</span><span class="p">:</span>
            <span class="c"># delete values</span>
            <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;DELETE FROM var_values WHERE subject = ?&quot;</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">subject</span><span class="p">,))</span>
            <span class="c"># delete subject</span>
            <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;DELETE FROM subjects WHERE subject = ?&quot;</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">subject</span><span class="p">,))</span>
    <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;DataBase not modified&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Done&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="initialize_database"><a class="viewcode-back" href="../../../library/tabular_data.html#braviz.readAndFilter.tabular_data.initialize_database">[docs]</a><span class="k">def</span> <span class="nf">initialize_database</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a new braviz database</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str) : Name of the new sqlite file that will contain the braviz database</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="kn">from</span> <span class="nn">braviz.readAndFilter.check_db</span> <span class="kn">import</span> <span class="n">verify_db_completeness</span>

    <span class="n">verify_db_completeness</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
        </div>

        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          
                

                

                

          
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
        &copy; Copyright 2014, Diego Angulo.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>







        
  </body>
</html>